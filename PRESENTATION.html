


<section>
  <h2>Opening</h2>

  Welcome
  - Who I am
  - Where I've been

  Chocolate up front
  Nomination of a REGULATOR


  I work at Tenscores, Tech Lead over there.

  We're building an awesome Google AdWords campaign soptimization platform.  Every AdWords marketing should know and try it out.

  Our use case:  we're a startup, and we need insights.
</section>


<section>
  <h2>What we'll cover</h2>

  - Gevent quick intro
  - Gevent-socketio, the new revamped, cross-framework
    - Show a bit of history, main contributors, jgelens, John Anderson, PyCon 2012 sprints
    - Show the old posts, videos
  - AngularJS, wire-in Socket.IO in there
  - Gevent-SocketIO:
     - Show example of integration with Django / Flask (in the examples repo)
  -

</section>


<section>
  <h2>gevent</h2>

  - Quick demo of parallel programming
  - Show off a couple of primitives
  - Monkey patch
  - pdb hangs everything
</section>

<section>
  <h2>AngularJS</h2>

  - Demo data binding
  - Get data from server (flat JSON), assign a var
  - Put in a directive, Plot it with a graph
  - Update the data on the server, and *hop*, the graph updates

  - Replace static data with live data, through Socket.IO though

  - Multiply the number of graphs, by adding more <ts-graph> to the view.
    Configured through an attribute.

  - Do something like the Evtrack directive, to collect from other parts of
    the UI.
</section>

<section>
  <h2>gevent-socketio</h2>

  - Persistence mech ? MongoDB ? In-memory ? Tailable cursor ?
  - Gather events through JSON
  - SocketIO context to send off values tail'd from the incoming flow
  - Demo MIXIN
  - Demo on_ things, recv_, disconnect, jobs spawn'd
    - On disconnect, register an event with a timespan (beginning on connection
      time).  Use the timeout of the socket to know the presence of the guy :)
</section>

<section>
  <h2>Pyramid and H5BP bootstrapping</h2>

  mkdir moo
  cd moo
  virtualenv env
  . env/bin/activate
  pip install pyramid
  pcreate -t starter Moo
  python Moo/setup.py develop  # not useful

  # Clean up default pyramid files
  rm -rf Moo/moo/templates/* Moo/moo/static/*

  # Load in H5BP
  git clone git://github.com/h5bp/html5-boilerplate.git
  cp html5-boilerplate/index.html Moo/moo/templates/
  cp -rv html5-boilerplate/{css,js,img} Moo/moo/static/

  # Fixup the index.html template
  replace "css/" by "/static/css/"
  replace "js/" by "/static/js/"
  # TODO: make a 'sed' call to do that..

  # In the background, tweak:
  developement.ini, add line: "mako.directories=moo:" under "use = egg:Moo"
  # This will use the 'moo' package's directory, so templates/boo will resolve
  # to the default location.

  # In the background, add:
  config.add_renderer('.html', "pyramid.mako_templating.renderer_factory")
  # to moo/__init__.py after "config = Configurator(settings=settings)"

  # Change the default template to load in `views.py`
  Put "templates/index.html" instead of "templates/mytemplate.pt"

  # Launch the dev server:
  cd ~/moo/Moo
  pserve --reload development.ini

  # Go in index.html, and ADD SOME SPACE AROUND THE "Hello world!" LINE

  # Connect to:
  http://localhost:6543/

  # And we're ready to go.
</section>


<section>
  <h2>Integrating AngularJS</h2>

  We'll use Google's CDN to simplify our job here..

  # Tweak index.html and add:
  <script src="//ajax.googleapis.com/ajax/libs/angularjs/1.0.2/angular.min.js"></script>
  # from https://developers.google.com/speed/libraries/devguide (fragment: #angularjs)
  # just after:
  <script src="/static/js/plugins.js"></script>

  # In the background, install a local copy of AngularJS and load it from here.
  cd ~/moo/Moo/moo/static/js/vendor
  wget http://code.angularjs.org/1.0.2/angular.min.js
  # Replace the line we just added from the Google CDN with:
  <script src="/static/js/vendor/angular.min.js"></script>

  # Add:
  ng-app="moo"
  # to our <html> tag

  # Add:
  ng-controller="MooCtrl"
  # to the <body> tag.

  # Add:
  ng-cloak
  # to the same body tag if we can, and add this to the `main.css` file:
  [ng\:cloak], [ng-cloak], .ng-cloak {
    display: none;
  }
  # See: http://docs.angularjs.org/api/ng.directive:ngCloak for more details.

  # Go to `main.js`, and add:
  angular.module('moo', [])
    .controller("MooCtrl", function($scope) {
      console.log("We're here!");
    })
  # See http://docs.angularjs.org/guide/di, see section "Inline Annotation" for the best way to declare these things.

  # Refresh page, show the console. and we're up :)
</section>

<section>
  <h2>Quick demo of AngularJS's data-binding</h2>

  # Add:
      $scope.who = 'Mama';
  # to MooCtrl

  # Change:
  "Hello World!" for "Hello {{who}}!"
  # in index.html, refresh, show that it uses the data, interpolation

  # We might want to explain at this point, the DOM-based templating, the
  # interpretation of the $scope from the DOM node, and the fact that any
  # child nodes can access the $scope.  The fact that $scope is attached
  # to the DOM node.

  # Show two-way, add the <input> tag, change:
  "<p>Hello {{who}}! This is <input ng-model="who" />.</p>"

  # Show off the two-way binding, explain that ng-model tweaks the $scope value
  # and any changes to the model get reflected (after a $digest() cycle) back
  # into the DOM, using the Observer pattern.  Each of those {{who}} set up
  # watches to update the DOM when they change.

  # For good performances, keep the number of watched under 2000 and
  # you're set.  You rarely need to have 2000 elements in one view to be
  # updated at a single time for the user to see the change and there
  # are plenty of ways to optimize the pattern.
</section>


<section>
  <h2>Bootstrap gevent and gevent-socketio</h2>

  cd ~/moo
  . env/bin/activate
  # Before, you'll need on your system: libevent-dev (Debian)
  pip install gevent gevent-socketio
  # TODO: warning, we need to install the Git version to have paster integration.
  # otherwise, we need to release to pypi a new -rc version.
  # or "mock" that part for the presentation.

  # Explain the different components:
  # Greenlets are micro-threads
  # Do something inspired by: http://blog.abourget.net/2011/3/17/new-and-hot-part-4-pyramid-socket-io-gevent/

  # In the previous version of gevent-socketio, we needed "pyramid_socketio", which
  # was yet another layer of integration.  Basically, all the good stuff and patterns
  # from pyramid_socketio, were extracted and made framework agnostic.

  # We now have integration demo for Flask, Django, Pyramid and a
  # barebone WSGI app (live_cpu_graph)

  # TODO: Install psutil for data gathering ?

  # Go in your development.ini file and change line:
  use = egg:waitress#main
  # for:
  use = egg:gevent-socketio#paster

  # Build a slide with some available options:
  transports = xhr-multipart, xhr-polling, websocket
  policy_server = True

  # We're now on top of Gevent, serving with Socket.IO
  # We'll just need to integrate some client service of the Socket.IO
  # protocol now (TODO: rephrase)

  # We'll want to monkey patch, so what I did is:
  cp ~/moo/env/bin/pserve ~/moo/env/bin/ppserve
  # and add the line:
  from gevent.monkey import patch_all; patch_all()
  # in ppserve down there, just before the last call.
</section>

<section>
  <h2>Wire-in the javascript socket.io lib and communicate</h2>

  # TODO: add socket.io <script>
  # Add the tag from CDN-js ("the missing cdn" as they call it) http://cdnjs.com
  <script src="//cdnjs.cloudflare.com/ajax/libs/socket.io/0.9.10/socket.io.min.js"></script>
  # just after the `angular.min.js` line.

  # In the background, replace that previous <script> line by:
  <script src="/static/js/vendor/socket.io.min.js"></script>
  # and run:
  cd ~/moo/Moo/moo/static/js/vendor
  wget http://cdnjs.cloudflare.com/ajax/libs/socket.io/0.9.10/socket.io.min.js
  # You're not safe from a flaky Internet :)



  # TODO: start writing an AngularJS service:
  .factory("$socketio", function($rootScope) {
    var socket = io.connect();
  })
  # Explain a bit of the dependency injection
  # Then, change:
  .controller("MooCtrl", function($scope) {
  # for:
  .controller("MooCtrl", function($scope, $socketio) {
  # and start to put some listeners.

  # TODO: fix the yasnippet "returnsocketio"

  # We'll wrap socket.io's lib so that when some data arrives, we actually
  # trigger Angular's $digest, and update the UI.



  # TODO: paste the socket_io connection method,
  # TODO: add_route to __init__.py:
+    config.add_route('socketio', 'socket.io/*remaining')  # based on `resource`

  # TODO: add something like:
+    $scope.cpu = 'waiting';
+
+    $socketio.on('cpu', function(data) {
+      $scope.cpu = data.cpu;
+    });
  # TODO and:
+        <p>CPU val: {{cpu}}</p>
  # in the template

  # In views.py, add something like:
+from socketio.namespace import BaseNamespace
+
+class GlobNamespace(BaseNamespace):
+    def connect(self):
+        self.emit("cpu", {"cpu": 123})
+
+@view_config(route_name="socketio")
+def iohandler(request):
+    from socketio import socketio_manage
+    print "BOO"
+    socketio_manage(request.environ, {"": GlobNamespace},
+                    request)

  # TODO: BUT IT DOESN'T WORK!
  # TODO: explain the different EVENTS, this is the CORE of the presentation
  #    how socketio works in Gevent!




  # TODO: Show a little service about how we connect
</section>

<section>
  <h2>Integration of the Graph</h2>

  Now let's see a graph with data coming from the server
</section>








Reference for AngularJS + D3 integration

http://briantford.com/blog/angular-d3.html
